generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

model Order {
    id                    String        @id @default(cuid())
    userId                String
    status                OrderStatus   @default(PENDING)
    paymentStatus         PaymentStatus @default(PENDING)
    total                 Float
    address               String
    city                  String
    zipCode               String
    paymentMethod         String
    stripeSessionId       String?       @unique
    stripePaymentIntentId String?       @unique
    createdAt             DateTime      @default(now())
    updatedAt             DateTime      @updatedAt
    User                  User          @relation(fields: [userId], references: [id])
    OrderItem             OrderItem[]

    @@index([status])
    @@index([userId])
    @@index([stripeSessionId])
}

model OrderItem {
    id        String  @id @default(cuid())
    orderId   String
    productId String
    quantity  Int
    price     Float
    Order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
    Product   Product @relation(fields: [productId], references: [id])

    @@index([orderId])
    @@index([productId])
}

model Product {
    id            String         @id @default(cuid())
    name          String
    description   String
    price         Float
    image         String // Primary image URL
    category      String
    stock         Int
    averageRating Float          @default(0)
    reviewCount   Int            @default(0)
    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @updatedAt
    OrderItem     OrderItem[]
    Review        Review[]
    ProductImage  ProductImage[]

    @@index([category])
    @@index([averageRating])
}

model ProductImage {
    id        String   @id @default(cuid())
    productId String
    url       String
    altText   String?
    order     Int      @default(0) // Display order
    product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())

    @@index([productId])
}

model Review {
    id        String   @id @default(cuid())
    rating    Int // 1-5 stars
    comment   String?
    userId    String
    productId String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, productId]) // One review per user per product
    @@index([productId])
    @@index([userId])
}

model User {
    id        String    @id @default(cuid())
    email     String    @unique
    fullName  String
    password  String    @default("")
    role      UserRole  @default(CUSTOMER)
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    Order     Order[]
    Address   Address[]
    Review    Review[]
}

model Address {
    id        String      @id @default(cuid())
    userId    String
    user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    type      AddressType
    label     String // "Home", "Work", "Other"
    address   String
    city      String
    zipCode   String
    phone     String?
    isDefault Boolean     @default(false)
    createdAt DateTime    @default(now())
    updatedAt DateTime    @updatedAt

    @@index([userId])
    @@index([userId, isDefault])
}

model AdminInvite {
    id        String    @id @default(cuid())
    email     String    @unique
    token     String    @unique
    role      UserRole  @default(ADMIN)
    invitedBy String
    expiresAt DateTime
    usedAt    DateTime?
    createdAt DateTime  @default(now())
}

enum UserRole {
    CUSTOMER
    ADMIN
    SUPER_ADMIN
}

enum AddressType {
    HOME
    SHIPPING
    BILLING
}

enum OrderStatus {
    PENDING
    PROCESSING
    SHIPPED
    DELIVERED
    CANCELLED
}

enum PaymentStatus {
    PENDING
    PROCESSING
    PAID
    FAILED
    REFUNDED
}
