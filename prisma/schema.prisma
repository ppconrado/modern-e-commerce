generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

model Order {
    id                    String        @id @default(cuid())
    userId                String
    status                OrderStatus   @default(PENDING)
    paymentStatus         PaymentStatus @default(PENDING)
    total                 Float
    address               String
    city                  String
    zipCode               String
    paymentMethod         String
    stripeSessionId       String?       @unique
    stripePaymentIntentId String?       @unique
    createdAt             DateTime      @default(now())
    updatedAt             DateTime      @updatedAt
    User                  User          @relation(fields: [userId], references: [id])
    OrderItem             OrderItem[]

    @@index([status])
    @@index([userId])
    @@index([stripeSessionId])
}

model OrderItem {
    id        String  @id @default(cuid())
    orderId   String
    productId String
    quantity  Int
    price     Float
    Order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
    Product   Product @relation(fields: [productId], references: [id])

    @@index([orderId])
    @@index([productId])
}

model Product {
    id            String         @id @default(cuid())
    name          String
    description   String
    price         Float
    image         String // Primary image URL
    category      String
    stock         Int
    averageRating Float          @default(0)
    reviewCount   Int            @default(0)
    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @updatedAt
    OrderItem     OrderItem[]
    Review        Review[]
    ProductImage  ProductImage[]
    WishlistItem  WishlistItem[]
    cartItems     CartItem[]

    @@index([category])
    @@index([averageRating])
}

model ProductImage {
    id        String   @id @default(cuid())
    productId String
    url       String
    altText   String?
    order     Int      @default(0) // Display order
    product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())

    @@index([productId])
}

model Review {
    id        String   @id @default(cuid())
    rating    Int // 1-5 stars
    comment   String?
    userId    String
    productId String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, productId]) // One review per user per product
    @@index([productId])
    @@index([userId])
}

model User {
    id           String         @id @default(cuid())
    email        String         @unique
    fullName     String
    password     String         @default("")
    role         UserRole       @default(CUSTOMER)
    isActive     Boolean        @default(true) // For soft delete/deactivation
    createdAt    DateTime       @default(now())
    updatedAt    DateTime       @updatedAt
    Order        Order[]
    Address      Address[]
    Review       Review[]
    WishlistItem WishlistItem[]
    Cart         Cart?
}

model Address {
    id        String      @id @default(cuid())
    userId    String
    user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    type      AddressType
    label     String // "Home", "Work", "Other"
    address   String
    city      String
    zipCode   String
    phone     String?
    isDefault Boolean     @default(false)
    createdAt DateTime    @default(now())
    updatedAt DateTime    @updatedAt

    @@index([userId])
    @@index([userId, isDefault])
}

model AdminInvite {
    id        String    @id @default(cuid())
    email     String    @unique
    token     String    @unique
    role      UserRole  @default(ADMIN)
    invitedBy String
    expiresAt DateTime
    usedAt    DateTime?
    createdAt DateTime  @default(now())
}

model WishlistItem {
    id        String   @id @default(cuid())
    userId    String
    productId String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())

    @@unique([userId, productId]) // One product per user in wishlist
    @@index([userId])
    @@index([productId])
}

model Cart {
    id             String        @id @default(cuid())
    userId         String?       @unique // NULL for anonymous carts
    anonymousId    String?       @unique // For anonymous users
    couponCode     String?
    discountAmount Float         @default(0)
    subtotal       Float         @default(0)
    total          Float         @default(0)
    createdAt      DateTime      @default(now())
    updatedAt      DateTime      @updatedAt
    user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
    items          CartItem[]
    CouponUsage    CouponUsage[]

    @@index([userId])
    @@index([anonymousId])
}

model CartItem {
    id        String   @id @default(cuid())
    cartId    String
    productId String
    quantity  Int      @default(1)
    price     Float // Price snapshot at time of add
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
    product   Product  @relation(fields: [productId], references: [id])

    @@unique([cartId, productId]) // One product variant per cart
    @@index([cartId])
    @@index([productId])
}

model Coupon {
    id                   String        @id @default(cuid())
    code                 String        @unique
    description          String?
    discountType         String        @default("PERCENTAGE") // PERCENTAGE or FIXED
    discountValue        Float // e.g., 10 (for 10%) or 50 (for $50)
    maxUses              Int? // NULL = unlimited
    usedCount            Int           @default(0)
    minimumAmount        Float         @default(0) // Minimum cart value
    maxAmount            Float? // Max cart value (NULL = no limit)
    applicableCategories String? // JSON array: ["electronics", "books"] or NULL = all
    startDate            DateTime
    endDate              DateTime
    isActive             Boolean       @default(true)
    createdAt            DateTime      @default(now())
    updatedAt            DateTime      @updatedAt
    CouponUsage          CouponUsage[]

    @@index([code])
    @@index([isActive])
    @@index([endDate])
}

model CouponUsage {
    id       String   @id @default(cuid())
    couponId String
    cartId   String
    userId   String?
    usedAt   DateTime @default(now())
    coupon   Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
    cart     Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

    @@unique([couponId, cartId]) // One coupon use per cart
    @@index([couponId])
    @@index([userId])
}

enum UserRole {
    CUSTOMER
    ADMIN
    SUPER_ADMIN
}

enum AddressType {
    HOME
    SHIPPING
    BILLING
}

enum OrderStatus {
    PENDING
    PROCESSING
    SHIPPED
    DELIVERED
    CANCELLED
}

enum PaymentStatus {
    PENDING
    PROCESSING
    PAID
    FAILED
    REFUNDED
}

model StoreSettings {
    id                     String   @id @default(cuid())
    storeName              String   @default("My Store")
    storeEmail             String   @default("")
    storePhone             String   @default("")
    storeAddress           String   @default("")
    currency               String   @default("USD")
    taxRate                Float    @default(0)
    shippingFee            Float    @default(0)
    freeShippingThreshold  Float    @default(0)
    lowStockThreshold      Int      @default(10)
    disableReviews         Boolean  @default(false)
    disableWishlist        Boolean  @default(false)
    disableMaintenanceMode Boolean  @default(false)
    createdAt              DateTime @default(now())
    updatedAt              DateTime @updatedAt
}
